name: Credit Risk MLOps CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:


jobs:

  # ========================
  # 1ï¸âƒ£ Train + Validate
  # ========================
  train_and_validate:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: ğŸ’¾ Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸŒ Set MLflow tracking URI for CI/CD
        # Use file-based mlruns inside workspace so MLflow calls succeed in CI
        run: echo "MLFLOW_TRACKING_URI=file://$GITHUB_WORKSPACE/mlruns" >> $GITHUB_ENV

      - name: ğŸ‹ï¸ Train model
        run: python src/train_model.py

      - name: ğŸ’¾ Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: models/model.pkl

      - name: âœ… Run model metric validation tests
        run: |
          echo "Running model validation tests..."
          pytest tests/test_model_metrics.py || exit 1

      - name: ğŸ§ª Run API endpoint tests
        run: |
          echo "Running API tests..."
          pytest tests/test_api.py || exit 1

      # Option A: If your train_model.py already registers & tags new version to Staging,
      # you can skip explicit staging promotion. If not, we'll promote in the next job.
      - name: ğŸ“¤ Upload MLflow runs directory
        uses: actions/upload-artifact@v4
        with:
          name: mlruns
          path: mlruns/

  
  # ========================
  # 3ï¸âƒ£ Test Staging Model
  # ========================
  test_staging_model:
    runs-on: ubuntu-latest
    needs: train_and_validate
    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ“¥ Download MLflow runs directory
        uses: actions/download-artifact@v4
        with:
          name: mlruns
          path: mlruns/

      - name: ğŸ“¥ Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: models/

      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸŒ Export MLFLOW_TRACKING_URI (file-based)
        run: echo "MLFLOW_TRACKING_URI=file://$GITHUB_WORKSPACE/mlruns" >> $GITHUB_ENV

      - name: ğŸ§ª Run staging tests (API + metrics)
        run: |
          echo "Running API tests and model checks against Staging..."
          pytest tests/test_api.py || exit 1
          pytest tests/test_model_metrics.py || exit 1

    # ========================
  # 4ï¸âƒ£ Promote to Production
  # ========================
  promote_to_production:
    runs-on: ubuntu-latest
    needs: test_staging_model
    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ“¥ Download MLflow runs directory
        uses: actions/download-artifact@v4
        with:
          name: mlruns
          path: mlruns/

      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸŒ Set MLflow tracking URI (file-based)
        run: echo "MLFLOW_TRACKING_URI=file://$GITHUB_WORKSPACE/mlruns" >> $GITHUB_ENV

      - name: ğŸš€ Promote model to Production
        run: python src/promote_model.py


  # ========================
  # 5ï¸âƒ£ Docker Build & Deploy
  # ========================
  deploy:
    runs-on: ubuntu-latest
    needs: promote_to_production
    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ“¥ Download MLflow runs directory
        uses: actions/download-artifact@v4
        with:
          name: mlruns
          path: mlruns/

      - name: ğŸ§± Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build Docker image
        run: docker build -t credit-risk-api:latest .

      - name: ğŸ§© Verify Docker image runs correctly
        run: |
          docker run --rm credit-risk-api:latest python -c "import sys; print('âœ… Image built successfully')"

      - name: ğŸ·ï¸ Tag Docker image
        run: docker tag credit-risk-api:latest ${{ secrets.DOCKER_USERNAME }}/credit-risk-api:latest

      - name: ğŸ“¤ Push Docker image to DockerHub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/credit-risk-api:latest

      # Optional: for self-hosted deployment servers
      - name: ğŸš€ Deploy container (if self-hosted)
        if: ${{ runner.environment == 'self-hosted' }}
        run: |
          docker stop credit-risk-api || true
          docker rm credit-risk-api || true
          docker run -d -p 8000:8000 \
            -e MLFLOW_TRACKING_URI=file://$(pwd)/mlruns \
            --name credit-risk-api \
            ${{ secrets.DOCKER_USERNAME }}/credit-risk-api:latest
